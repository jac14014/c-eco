<script>
document.addEventListener('DOMContentLoaded', () => {

  /* ============================================================
     1) MAPEAMENTO DO DOM
  ============================================================ */
  const inputField = document.getElementById('command-input');
  const executeBtn = document.getElementById('execute-btn');
  const consoleOutput = document.getElementById('console-output');

  const scrollToBottom = () => {
    consoleOutput.scrollTop = consoleOutput.scrollHeight;
  };

  /* ============================================================
     2) UTILITÁRIOS / SANITIZAÇÃO
  ============================================================ */
  const escapeHtml = (str = '') =>
    str.replace(/[&<>"']/g, (m) => ({
      '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;'
    }[m]));

  async function generateSigmaHash(text) {
    const msgUint8 = new TextEncoder().encode(text);
    const hashBuffer = await crypto.subtle.digest('SHA-256', msgUint8);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    return hashHex.substring(0, 12).toUpperCase();
  }

  /* ============================================================
     3) COMPONENTES DE UI
  ============================================================ */
  function createUserMessage(text) {
    const div = document.createElement('div');
    div.className = "flex justify-end pl-12 mb-6";
    div.innerHTML = `
      <div class="bg-zinc-800/50 border border-sigma/20 text-zinc-300 p-3 rounded-sm max-w-xl">
        <span class="text-[0.6rem] text-sigma/50 font-mono block mb-1">
          INPUT SOURCE: HUMAN AGENCY &gt;
        </span>
        <p class="text-sm font-mono">${escapeHtml(text)}</p>
      </div>`;
    return div;
  }

  function renderCECOOutput(payload) {
    const refs = (arr) =>
      (arr || []).map(r =>
        `<code class="text-[0.65rem] bg-white/5 px-1 font-mono text-sigma/80">${r}</code>`
      ).join(' ');

    return `
      <div class="space-y-4">
        <section>
          <h3 class="text-white font-tech text-[0.7rem] uppercase tracking-widest border-b border-white/5 mb-2">
            A) Systemic State
          </h3>
          <div class="flex items-center gap-2 mb-1">
            <span class="px-2 py-0.5 rounded bg-sigma/10 border border-sigma/30 text-sigma text-[0.65rem] font-mono">
              ${payload.state}
            </span>
            <span class="text-[0.65rem] text-zinc-500 font-mono">
              CONFIDENCE: ${payload.confidence}
            </span>
          </div>
          <p class="text-[0.7rem] text-zinc-400">
            Basis: ${refs(payload.state_basis)}
          </p>
        </section>

        <section>
          <h3 class="text-white font-tech text-[0.7rem] uppercase tracking-widest border-b border-white/5 mb-2">
            B) Mandatory Triggers
          </h3>
          ${payload.triggers.length
            ? payload.triggers.map(t =>
                `<div class="text-xs text-zinc-300"><span class="text-sigma">▶</span> ${t}</div>`
              ).join('')
            : `<span class="text-zinc-600 text-[0.7rem] italic">No triggers activated.</span>`
          }
        </section>

        <section>
          <h3 class="text-white font-tech text-[0.7rem] uppercase tracking-widest border-b border-white/5 mb-2">
            C) Binding Legal Effects
          </h3>
          <ul class="list-disc pl-4 space-y-1 text-xs text-zinc-200">
            ${payload.effects.map(e => `<li>${e}</li>`).join('')}
          </ul>
        </section>

        <section class="bg-blue-950/10 p-2 border-l-2 border-blue-500/30">
          <h3 class="text-blue-400 font-tech text-[0.6rem] uppercase tracking-widest mb-1">
            D) Proof & Immutable Logs
          </h3>
          <p class="text-[0.65rem] font-mono text-zinc-400">${payload.proof}</p>
          <div class="mt-1 text-[0.55rem] text-blue-300/60 uppercase font-mono">
            Evidence Bound: ${refs(payload.proof_basis)}
          </div>
        </section>
      </div>
    `;
  }

  function appendAuditLog(entry) {
    const container = document.getElementById('audit-logs');
    if (!container) return;

    const placeholder = container.querySelector('.italic');
    if (placeholder) placeholder.remove();

    const ts = new Date().toISOString().replace('T', ' ').slice(0, 19);
    const div = document.createElement('div');
    div.className = "border-l border-white/10 pl-2";

    div.innerHTML = `
      <div class="text-[0.55rem] font-mono text-zinc-500">${ts}</div>
      <div class="text-[0.6rem] font-mono text-zinc-300">${entry}</div>
    `;

    container.appendChild(div);
  }

  /* ============================================================
     4) ENGINE DECISIONAL (c-ECO)
  ============================================================ */
  function decide(command) {
    const lower = command.toLowerCase();
    const state_basis = ["CECO-ART-083", "CECO-ART-085"];

    if (lower.includes("iex")) {
      return {
        state: "RED / CRITICAL",
        confidence: "40% (UNCERTAIN)",
        confidence_score: 40,
        state_basis,
        triggers: ["Ex-Ante Unenforceability (IEX)"],
        effects: [
          "Immediate suspension of enforceability.",
          "Blocking of acts that aggravate collapse trajectory."
        ],
        proof: "Certified sensory + legal data",
        proof_basis: ["CECO-ART-035", "CECO-ART-071", "CECO-ART-072"],
        isAlert: true
      };
    }

    if (lower.includes("safe")) {
      return {
        state: "ORANGE / CONTAINMENT",
        confidence: "HIGH",
        confidence_score: 72,
        state_basis,
        triggers: ["Safe Mode engaged"],
        effects: ["Coordinated suspension across agents."],
        proof: "Containment logs active",
        proof_basis: ["CECO-ART-044", "CECO-ART-086"],
        isAlert: true
      };
    }

    return {
      state: "YELLOW / MONITORING",
      confidence: "STABLE",
      confidence_score: 68,
      state_basis,
      triggers: [],
      effects: ["Execution allowed under continuous monitoring."],
      proof: "Continuous stream active",
      proof_basis: ["CECO-ART-035", "CECO-ART-086"],
      isAlert: false
    };
  }

  /* ============================================================
     5) SIDEBAR + BLIND INTERVAL
  ============================================================ */
  function updateSidebar(payload) {
    const human = document.querySelector('#bar-human > div');
    const alg   = document.querySelector('#bar-algorithmic > div');
    const eco   = document.querySelector('#bar-ecological > div');
    const gap   = document.getElementById('gap-indicator');
    const gapTxt= document.getElementById('gap-status');

    if (!human || !alg || !eco || !gap || !gapTxt) return;

    const score = Number(payload.confidence_score ?? 100);
    gap.style.left = `${Math.max(5, Math.min(95, score))}%`;

    if (score < 60) {
      gapTxt.textContent = "BLIND INTERVAL";
      gapTxt.className = "text-red-500 animate-pulse";
    } else {
      gapTxt.textContent = "MONITORING";
      gapTxt.className = "text-zinc-500";
    }
  }

  function applyBlindInterval(payload) {
    const sidebar = document.getElementById('system-sidebar');
    if (!sidebar) return;
    if ((payload.confidence_score ?? 100) < 60) {
      sidebar.classList.add('opacity-30', 'blur-[2px]');
    } else {
      sidebar.classList.remove('opacity-30', 'blur-[2px]');
    }
  }

  /* ============================================================
     6) ORQUESTRADOR
  ============================================================ */
  async function executeCommand() {
    const command = inputField.value.trim();
    if (!command) return;

    consoleOutput.appendChild(createUserMessage(command));
    inputField.value = '';
    scrollToBottom();

    const loader = document.createElement('div');
    loader.className = "text-[0.6rem] font-mono text-sigma p-2";
    loader.textContent = "Running Sieve Analysis…";
    consoleOutput.appendChild(loader);

    setTimeout(async () => {
      loader.remove();

      const payload = decide(command);

      const ts = new Date().toISOString();
      const safeCmd = escapeHtml(command);
      const raw = `${safeCmd}|${payload.state}|${payload.confidence_score ?? ''}`;

      let proof = 'UNAVAILABLE';
      try { proof = await generateSigmaHash(raw); } catch(e){}

      updateSidebar(payload);
      applyBlindInterval(payload);

      appendAuditLog(
        `TS=${ts} | CMD="${safeCmd.toUpperCase()}" | STATE=${payload.state} | SIGMA-SHA256-${proof}`
      );

      const html = renderCECOOutput(payload);
      const borderColor = payload.isAlert ? "border-red-500/50" : "border-sigma/40";
      const header = payload.isAlert ? "[ PREDICTIVE ALERT ]" : "[ TRAJECTORY ASSESSMENT ]";

      const div = document.createElement('div');
      div.className = "flex justify-start pr-12 mb-6";
      div.innerHTML = `
        <div class="w-full max-w-3xl">
          <div class="border-l-[1px] ${borderColor} bg-[#18181b]/80 p-5 pl-6">
            <div class="flex gap-4 mb-3 font-mono text-[0.65rem] text-sigma/80 uppercase border-b border-white/5 pb-2">
              <span>${header}</span>
              <span class="text-zinc-500">SYSTEMIC PROOF · SHA-256 · ${proof}</span>
            </div>
            <div class="text-zinc-300 font-light">${html}</div>
          </div>
        </div>`;

      consoleOutput.appendChild(div);
      scrollToBottom();
    }, 1200);
  }

  executeBtn.addEventListener('click', executeCommand);
  inputField.addEventListener('keypress', e => { if (e.key === 'Enter') executeCommand(); });

});
</script>